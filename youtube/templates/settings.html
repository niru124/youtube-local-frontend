{% set page_title = 'Settings' %}
{% extends "base.html" %}
{% import "common_elements.html" as common_elements %}
{% block style %}
    .settings-form {
        margin: auto;
        max-width: 600px;
        margin-top:10px;
        padding: 10px;
        display: block;
        background-color: var(--interface-color);
    }
        .settings-list{
            list-style: none;
            padding: 0px;
        }
            .setting-item{
                margin-bottom: 10px;
                padding: 5px;
            }
                .setting-item label{
                    display: inline-block;
                    width: 250px;
                }
    @media (max-width:650px){
        h2{
            text-align: center;
        }
        .setting-item{
        }
            .setting-item label{
                display: block; /* make the setting input wrap */
                margin-bottom: 5px;
            }
    }

    .history-management-form {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }

    .history-management-form input[type="file"] {
        padding: 8px;
        border: 1px solid var(--ctp-surface1);
        border-radius: 8px;
        background-color: var(--ctp-base);
        color: var(--ctp-text);
    }

    .history-management-form input[type="submit"] {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95rem;
        transition: all 0.2s ease-in-out;
    }

    .history-management-form input[type="submit"][value="Export History"] {
        background-color: var(--ctp-blue);
        color: var(--ctp-crust);
    }

    .history-management-form input[type="submit"][value="Export History"]:hover {
        background-color: var(--ctp-sapphire);
    }

    .history-management-form input[type="submit"][value="Import History"] {
        background-color: var(--ctp-green);
        color: var(--ctp-crust);
    }

    .history-management-form input[type="submit"][value="Import History"]:hover {
        background-color: var(--ctp-teal);
    }
{% endblock style %}

{% block main %}
    <form method="POST" class="settings-form">
        {% for categ in categories %}
            <h2>{{ categ|capitalize }}</h2>
            <ul class="settings-list">
            {% for setting_name, setting_info, value in settings_by_category[categ] %}
                {% if not setting_info.get('hidden', false) %}
                    <li class="setting-item">
                        {% if 'label' is in(setting_info) %}
                            <label for="{{ 'setting_' + setting_name }}">{{ setting_info['label'] }}</label>
                        {% else %}
                            <label for="{{ 'setting_' + setting_name }}">{{ setting_name.replace('_', ' ')|capitalize }}</label>
                        {% endif %}

                        {% if setting_info['type'].__name__ == 'bool' %}
                            <input type="checkbox" id="{{ 'setting_' + setting_name }}" name="{{ setting_name }}" {{ 'checked' if value else '' }}>
                        {% elif setting_info['type'].__name__ == 'int' %}
                            {% if 'options' is in(setting_info) %}
                                <select id="{{ 'setting_' + setting_name }}" name="{{ setting_name }}">
                                    {% for option in setting_info['options'] %}
                                        <option value="{{ option[0] }}" {{ 'selected' if option[0] == value else '' }}>{{ option[1] }}</option>
                                    {% endfor %}
                                </select>
                            {% elif 'max' in setting_info and 'min' in setting_info %}
                                <input type="number" id="{{ 'setting_' + setting_name }}" name="{{ setting_name }}" value="{{ value }}" min="{{ setting_info['min'] }}" max="{{ setting_info['max'] }}">
                            {% else %}
                                <input type="number" id="{{ 'setting_' + setting_name }}" name="{{ setting_name }}" value="{{ value }}" step="1">
                            {% endif %}
                        {% elif setting_info['type'].__name__ == 'float' %}

                        {% elif setting_info['type'].__name__ == 'str' %}
                            <input type="text" id="{{ 'setting_' + setting_name }}" name="{{ setting_name }}" value="{{ value }}">
                        {% else %}
                            <span>Error: Unknown setting type: setting_info['type'].__name__</span>
                        {% endif %}
                    </li>
                {% endif %}
            {% endfor %}
            </ul>
        {% endfor %}
        <input type="submit" value="Save settings">
    </form>
    <h2>History Management</h2>
    <div class="settings-form">
        <form class="history-management-form" action="{{ util.URL_ORIGIN }}/videolog/export" method="GET">
            <input type="submit" value="Export History">
            <select name="format" style="padding: 8px; border-radius: 8px; background-color: var(--ctp-base); color: var(--ctp-text); border: 1px solid var(--ctp-surface1);">
                <option value="txt">Plain Text (.txt)</option>
                <option value="json">JSON (.json)</option>
            </select>
        </form>
        <form class="history-management-form" action="{{ util.URL_ORIGIN }}/videolog/import" method="POST" enctype="multipart/form-data">
            <input type="file" name="history_file" accept=".txt">
            <input type="submit" value="Import History">
        </form>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const defaultSpeedInput = document.getElementById('setting_default_playback_speed');

            // Load saved default speed on page load
            const savedDefaultSpeed = localStorage.getItem('defaultPlaybackSpeed');
            if (savedDefaultSpeed) {
                defaultSpeedInput.value = savedDefaultSpeed;
            }

            // Save default speed when input changes
            defaultSpeedInput.addEventListener('change', function() {
                localStorage.setItem('defaultPlaybackSpeed', this.value);
            });
        });
    </script>
{% endblock main %}
