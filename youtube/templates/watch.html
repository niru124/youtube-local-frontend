{% set page_title = title %}
{% extends "base.html" %}
{% import "common_elements.html" as common_elements %}
{% import "comments.html" as comments with context %}
{% block style %}
    body {
        --theater_video_target_width: {{ theater_video_target_width }};
        --video_height: {{ video_height }};
        --video_width: {{ video_width }};
        --plyr-control-spacing-num: {{ '3' if video_height < 240 else '10' }};
        --screen-width: calc(100vw - 40px); /* Adjusted for new main padding */
    }

    .playability-error, .live-url-choices {
        height: 360px;
        max-width: 640px;
        grid-column: 2;
        text-align:center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
        .playability-error span{
            white-space: pre-wrap;
        }

    .live-url-choices ol{
        list-style: none;
        padding:0px;
        margin:0px;
        margin-top: 15px;
    }
    .live-url-choices input{
        max-width: 400px;
        width: 100%;
    }
    .url-choice-label{
        display: inline-block;
        width: 150px;
    }

    {% if settings.theater_mode %}
        #video-container{
            grid-column: 1 / span 5;
            justify-self: center;
            max-width: 100%;
            max-height: calc(var(--screen-width)*var(--video_height)/var(--video_width));
            height: calc(var(--video_height)*1px);
            width: calc(var(--theater_video_target_width)*1px);
            margin-bottom: 20px; /* Increased margin */
            --plyr-video-background: rgba(0, 0, 0, 0);
        }

        {% set heights = [] %}

        {% for src in uni_sources+pair_sources %}
            {% if src['height'] not in heights %}
                {% do heights.append(src['height']) %}
                @media(max-height:{{ src['height'] + 50 }}px){
                    #video-container.h{{ src['height'] }}{
                        height: calc(100vh - 50px); /* 50px is height of header */
                    }
                }
            {% endif %}
        {% endfor %}

        video{
            background-color: var(--ctp-crust); /* Use crust for video background */
        }
        #video-container > video, #video-container > .plyr{
            width: 100%;
            height: 100%;
            border-radius: 8px; /* Rounded corners for video player */
            overflow: hidden;
        }
        .side-videos{
            grid-row: 2 /span 3;
            max-width: 400px;
        }
        .video-info{
            max-width: 640px;
        }
    {% else %}
        #video-container{
            grid-column: 2;
        }
        #video-container, video{
            height: calc(640px*var(--video_height)/var(--video_width)) !important;
            width: 640px !important;
            border-radius: 8px; /* Rounded corners for video player */
            overflow: hidden;
        }
        .plyr {
            height: 100%;
            width: 100%;
        }
        .side-videos{
            grid-row: 1 /span 4;
        }
    {% endif %}

    main{
        display:grid;
        /* 5 columns: left-padding, video, info/side-videos, comments, right-padding */
        grid-template-columns: minmax(0, 1fr) minmax(640px, 1fr) minmax(0, 0.5fr) minmax(0, 0.5fr) minmax(0, 1fr);
        grid-template-rows: auto auto; /* video, then info/side, then comments */
        align-content: start;
        /* Padding handled by shared.css now */
    }

        .video-info{
            grid-column: 2;
            grid-row: 2;
            display: grid;
            grid-template-columns: 1fr 1fr;
            align-content: start;
            grid-template-areas:
                "v-title                  v-title"
                "v-labels                 v-labels"
                "v-uploader               v-views"
                "v-date                   v-likes-dislikes"
                "external-player-controls v-checkbox"
                "v-direct-link            v-direct-link"
                "v-download               v-download"
                "v-description            v-description"
                "v-music-list             v-music-list"
                "v-more-info              v-more-info";
            padding: 16px; /* Consistent padding with other content boxes */
            background-color: var(--ctp-surface0); /* Consistent background */
            border-radius: 8px; /* Consistent border-radius */
            margin-top: 20px; /* Space from video player */
        }
            .video-info > .title{
                grid-area: v-title;
                min-width: 0;
                font-size: 1.8rem; /* Larger title */
                font-weight: 700;
                margin-bottom: 10px;
            }
            .video-info > .labels{
                grid-area: v-labels;
                justify-self:start;
                list-style: none;
                padding: 0px;
                margin: 0px 0px 15px 0px; /* Adjusted margin */
            }
            .video-info > .labels:empty{
                margin: 0px;
            }
            .video-info > address{
                grid-area: v-uploader;
                justify-self: start;
                font-size: 1.1rem;
                color: var(--ctp-subtext1);
            }
            .video-info > .views{
                grid-area: v-views;
                justify-self:end;
                font-size: 1.1rem;
                color: var(--ctp-subtext1);
            }
            .video-info > time{
                grid-area: v-date;
                justify-self:start;
                font-size: 1.1rem;
                color: var(--ctp-subtext1);
            }
            .video-info > .likes-dislikes{
                grid-area: v-likes-dislikes;
                justify-self:end;
                font-size: 1.1rem;
                color: var(--ctp-subtext1);
            }
            .video-info > .external-player-controls{
                grid-area: external-player-controls;
                justify-self: start;
                margin-top: 15px; /* Space from previous elements */
                margin-bottom: 15px;
                display: flex;
                gap: 10px; /* Space between controls */
                align-items: center;
            }
                #speed-control, #quality-select {
                    width: 120px; /* Wider for better usability */
                    text-align: center;
                }
            .video-info > .checkbox{
                grid-area: v-checkbox;
                justify-self:end;
                align-self: center; /* Vertically align with controls */
                height: 25px;
                width: 25px;
            }
            .video-info > .direct-link{
                grid-area: v-direct-link;
                margin-bottom: 15px;
            }
            .video-info > .download-dropdown{
                grid-area: v-download;
                margin-bottom: 15px;
            }
            .video-info > .description-container{
                margin-top:15px;
                grid-area: v-description;
            }
                .video-info > .description-container > summary{
                    font-weight: normal;
                    border-width: 0;
                }
                .video-info > .description-container > .description{
                    white-space: pre-wrap;
                    min-width: 0;
                    word-wrap: break-word;
                    padding: 0; /* Padding handled by parent .video-info */
                }

            .music-list{
                grid-area: v-music-list;
                padding-bottom: 7px;
                margin-top: 15px;
            }
                .music-list table,th,td{
                    border: 1px solid var(--ctp-surface1); /* Catppuccin border */
                }
                .music-list th,td{
                    padding-left:8px; /* Increased padding */
                    padding-right:8px;
                }
                .music-list caption{
                    text-align:left;
                    font-weight:bold;
                    margin-bottom:10px; /* Increased margin */
                    font-size: 1.2rem;
                    color: var(--ctp-mauve);
                }
            .more-info{
                grid-area: v-more-info;
                margin-top: 15px;
            }
                .more-info > summary{
                    font-weight: normal;
                    border-width: 0; /* Border handled by shared.css */
                }
                .more-info-content{
                    padding: 0; /* Padding handled by shared.css */
                }
                    .more-info-content p{
                        margin: 8px 0px;
                    }

        /*  NEW LAYOUT */
        .side-and-comments-container {
            grid-column: 1 / -1; /* Span the full width */
            grid-row: 3; /* Put it on the new row */
            display: flex;
            width: 100%;
            padding: 0 20px; /* Match the main padding */
            box-sizing: border-box; /* Include padding in the width */
        }

        .side-videos{
            width: 60%; /* 40% for related videos */
            padding-right: 20px;
            box-sizing: border-box;
        }

        .comments-area-outer{
            width: 40%; /* 60% for comments */
            box-sizing: border-box;
        }

        .comments-disabled{
            padding: 16px; /* Consistent padding */
            font-weight: bold;
        }
        .comments-area-inner{
            padding-top: 10px;
        }
            .comment{
                max-width:100%;
            }

        .side-videos{
            list-style: none;
            max-width: initial;
            margin-top:20px;
        }
            #transcript-details{
                margin-bottom: 15px;
            }
                table#transcript-table {
                    border-collapse: collapse;
                    width: 100%;
                }
                table#transcript-table td, th {
                    border: 1px solid var(--ctp-overlay0);
                }
                div#transcript-div {
                    padding: 16px; /* Consistent padding */
                }
            .playlist{
                border: 1px solid var(--ctp-surface1); /* Consistent border */
                border-radius: 8px; /* Consistent border-radius */
                margin-bottom: 15px;
                background-color: var(--ctp-surface0); /* Consistent background */
            }
                .playlist-header{
                    padding: 12px 16px; /* Increased padding */
                    border-bottom: 1px solid var(--ctp-surface1); /* Consistent border */
                    border-radius: 8px 8px 0 0; /* Rounded top corners */
                }
                    .playlist-header h3{
                        margin: 0;
                        font-size: 1.3rem;
                        color: var(--ctp-text);
                    }
                    .playlist-metadata{
                        list-style: none;
                        padding: 0px;
                        margin: 5px 0px 0px 0px;
                        font-size: 0.9rem;
                        color: var(--ctp-subtext0);
                    }
                        .playlist-metadata li{
                            display: inline;
                            margin-right: 10px;
                        }
                .playlist-videos{
                    height: 500px;
                    overflow-y: auto; /* Changed to auto for scrollbar only when needed */
                    display: grid;
                    grid-auto-rows: 90px;
                    grid-row-gap: 10px;
                    padding: 10px 16px; /* Consistent padding */
                }
            .autoplay-toggle-container{
                margin-bottom: 15px;
                display: flex;
                align-items: center;
                background-color: var(--ctp-surface0);
                padding: 12px 16px;
                border-radius: 8px; /* Consistent border-radius */
                box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14);
                border: 1px solid var(--ctp-surface1);
            }
            .autoplay-toggle-container label {
                color: var(--ctp-text);
                font-size: 1rem;
                margin-right: 10px;
                cursor: pointer;
            }
            .autoplay-toggle-container input[type="checkbox"] {
                /* Style for the checkbox itself */
                appearance: none;
                -webkit-appearance: none;
                -moz-appearance: none;
                width: 24px;
                height: 24px;
                border: 2px solid var(--ctp-overlay0);
                border-radius: 4px;
                background-color: var(--ctp-base);
                cursor: pointer;
                position: relative;
                transition: background-color 0.2s, border-color 0.2s;
            }

            .autoplay-toggle-container input[type="checkbox"]:checked {
                background-color: var(--ctp-blue);
                border-color: var(--ctp-blue);
            }

            .autoplay-toggle-container input[type="checkbox"]:checked::after {
                content: '\2713'; /* Checkmark character */
                font-size: 16px;
                color: var(--ctp-crust);
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            }

            .autoplay-toggle-container input[type="checkbox"]:focus {
                outline: none;
                box-shadow: 0 0 0 3px rgba(var(--ctp-blue-rgb), 0.3);
            }

            .related-videos-inner{
                padding-top: 15px;
                display: grid;
                grid-auto-rows: 90px;
                grid-row-gap: 20px;
            }
                .thumbnail-box{     /* overides rule in shared.css */
                    height: 90px !important;
                    width: 170px !important;
                }

    .download-dropdown-content{
        padding: 10px;
        list-style: none;
        margin: 0px;
    }
        li.download-format{
            margin-bottom: 7px;
        }
            .download-link{
                display: block;
                background-color: var(--ctp-surface1); /* Use surface1 for download links */
                padding: 8px 12px;
                border-radius: 4px;
                transition: background-color 0.2s ease-in-out;
            }
            .download-link:hover{
                background-color: var(--ctp-surface2);
            }
            .download-link:visited{
                color: var(--ctp-subtext0); /* Adjust visited link color */
            }
                .format-attributes{
                    list-style: none;
                    padding: 0px;
                    margin: 0px;
                    display: flex;
                    flex-direction: row;
                    flex-wrap: wrap;
                    gap: 10px; /* Space between attributes */
                }
                    .format-attributes li{
                        white-space: nowrap;
                        max-height: 1.2em;
                        color: var(--ctp-subtext1); /* Subtext color for attributes */
                    }
                    .format-ext{
                        width: 60px;
                    }
                    .format-video-quality{
                        width: 140px;
                    }
                    .format-audio-quality{
                        width: 120px;
                    }
                    .format-file-size{
                        width: 80px;
                    }
                    .format-codecs{

                    }

    .chapters-above-comments {
        margin: 20px 0;
        padding: 15px;
        background-color: var(--ctp-surface0);
        border-radius: 8px;
        border: 1px solid var(--ctp-surface2);
    }

    .chapters-above-comments h3 {
        margin: 0 0 15px 0;
        color: var(--ctp-lavender);
        font-size: 1.1em;
    }

    .chapters-checkbox-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .chapter-checkbox-item {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s ease;
        background-color: var(--ctp-surface1);
    }

    .chapter-checkbox-item:hover {
        background-color: var(--ctp-surface2);
    }

    .chapter-checkbox {
        margin-right: 12px;
        accent-color: var(--ctp-blue);
    }

    .chapter-time {
        font-family: monospace;
        color: var(--ctp-blue);
        margin-right: 12px;
        min-width: 60px;
        font-size: 0.9em;
    }

    .chapter-title {
        flex: 1;
        color: var(--ctp-text);
        cursor: pointer;
    }

    .chapter-title:hover {
        color: var(--ctp-blue);
        text-decoration: underline;
    }

    /* Put related vids below videos when window is too small */
    /* 1100px instead of 1080 because W3C is full of idiots who include scrollbar width */
    @media (max-width:1100px){
        main{
            grid-template-columns: 5px minmax(0, 1fr) 5px;
        }
        .side-and-comments-container{
            flex-direction: column;
        }
        .side-videos, .comments-area-outer{
            width: 100%;
        }
    }

    @media (max-width:660px){
        main{
            grid-template-columns: 5px minmax(0, 1fr) 5px;
        }
        .format-attributes{
            display: grid;
            grid-template-columns: repeat(auto-fill, 140px);
        }
            .format-codecs{
                grid-column: auto / span 2;
            }
    }
    @media (max-width:500px){
        .video-info{
            grid-template-areas:
                "v-title                  v-title"
                "v-labels                 v-labels"
                "v-uploader               v-uploader"
                "v-date                   v-date"
                "v-views                  v-views"
                "v-likes-dislikes         v-likes-dislikes"
                "external-player-controls v-checkbox"
                "v-direct-link            v-direct-link"
                "v-download               v-download"
                "v-description            v-description"
                "v-music-list             v-music-list"
                "v-more-info              v-more-info";
        }
            .video-info > .views{
                justify-self: start;
            }
            .video-info > .likes-dislikes{
                justify-self: start;
            }
    }
{% endblock style %}

{% block head %}
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline'; connect-src 'self' https://sponsor.ajay.app https://api.sponsor.ajay.app; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:;" />
    {% if settings.video_player == 1 %}
        <!-- plyr -->
        <link href="/youtube.com/static/modules/plyr/plyr.css" rel="stylesheet"/>
        <link href="/youtube.com/static/plyr_fixes.css" rel="stylesheet"/>
        <!--/ plyr -->
    {% endif %}
{% endblock head %}

{% block main %}
    {% if playability_error %}
        <div class="playability-error">
            <span>{{ 'Error: ' + playability_error }}
            {% if invidious_reload_button %}
                <a href="{{ video_url }}&use_invidious=0"><br>
Reload without invidious (for usage of new identity button).</a>
            {% endif %}
            </span>
        </div>
    {% elif (uni_sources.__len__() == 0 or live) and hls_formats.__len__() != 0 %}
        <div class="live-url-choices">
            <span>Copy a url into your video player:</span>
            <ol>
                {% for fmt in hls_formats %}
                    <li class="url-choice"><div class="url-choice-label">{{ fmt['video_quality'] }}: </div><input class="url-choice-copy" value="{{ fmt['url'] }}" readonly onclick="this.select();"></li>
                {% endfor %}
            </ol>
        </div>
    {% else %}
        <div id="video-container" class="h{{video_height}}"> <!--Do not add other classes here, classes changed by javascript-->
            <video controls autofocus class="video" {{ 'autoplay' if settings.autoplay_videos }}>
                {% if uni_sources %}
                    <source src="{{ uni_sources[uni_idx]['url'] }}" type="{{ uni_sources[uni_idx]['type'] }}" data-res="{{ uni_sources[uni_idx]['quality'] }}">
                {% endif %}

                {% for source in subtitle_sources %}
                    {% if source['on'] %}
                        <track label="{{ source['label'] }}" src="{{ source['url'] }}" kind="subtitles" srclang="{{ source['srclang'] }}" default>
                    {% else %}
                        <track label="{{ source['label'] }}" src="{{ source['url'] }}" kind="subtitles" srclang="{{ source['srclang'] }}">
                    {% endif %}
                {% endfor %}
            </video>
        </div>
    {% endif %}

    <div class="video-info">
        <h2 class="title">{{ title }}</h2>
        <ul class="labels">
            {%- if unlisted -%}
                <li class="is-unlisted">Unlisted</li>
            {%- endif -%}
            {%- if age_restricted -%}
                <li class="age-restricted">Age-restricted</li>
            {%- endif -%}
            {%- if limited_state -%}
                <li class="limited-state">Limited state</li>
            {%- endif -%}
            {%- if live -%}
                <li class="live">Live</li>
            {%- endif -%}
        </ul>
        <address>Uploaded by <a href="{{ uploader_channel_url }}">{{ uploader }}</a></address>
        <span class="views">{{ view_count }} views</span>


        <time datetime="$upload_date">Published on {{ time_published }}</time>
        <span class="likes-dislikes">{{ like_count }} likes {{ dislike_count }} dislikes</span>

        <div class="external-player-controls">
            <input type="number" id="speed-control" class="material-select" placeholder="Speed" step="0.05" min="0.1" max="4.0" list="speed-options">
            <datalist id="speed-options">
                <option value="0.25"></option>
                <option value="0.5"></option>
                <option value="0.75"></option>
                <option value="1.0"></option>
                <option value="1.25"></option>
                <option value="1.5"></option>
                <option value="1.75"></option>
                <option value="2.0"></option>
                <option value="2.1"></option>
                <option value="2.2"></option>
                <option value="2.3"></option>
                <option value="2.4"></option>
                <option value="2.5"></option>
                <option value="2.6"></option>
                <option value="2.7"></option>
                <option value="2.8"></option>
                <option value="2.9"></option>
                <option value="3.0"></option>
            </datalist>
            {% if settings.video_player == 0 %}
                <select id="quality-select" autocomplete="off" class="material-select">
                    {% for src in uni_sources %}
                        <option value='{"type": "uni", "index": {{ loop.index0 }}}' {{ 'selected' if loop.index0 == uni_idx and not using_pair_sources else '' }} >{{ src['quality_string'] }}</option>
                    {% endfor %}
                    {% for src_pair in pair_sources %}
                        <option value='{"type": "pair", "index": {{ loop.index0}}}' {{ 'selected' if loop.index0 == pair_idx and using_pair_sources else '' }} >{{ src_pair['quality_string'] }}</option>
                    {% endfor %}
                </select>
            {% endif %}
        </div>
        <input class="checkbox" name="video_info_list" value="{{ video_info }}" form="playlist-edit" type="checkbox">

        <span class="direct-link"><a href="https://youtu.be/{{ video_id }}">Direct Link</a></span>

        <details class="download-dropdown">
            <summary class="download-dropdown-label">Download</summary>
            <ul class="download-dropdown-content">
                {% for format in download_formats %}
                    <li class="download-format">
                        <a class="download-link" href="{{ format['url'] }}">
                            <ol class="format-attributes">
                                <li class="format-ext">{{ format['ext'] }}</li>
                                <li class="format-video-quality">{{ format['video_quality'] }}</li>
                                <li class="format-audio-quality">{{ format['audio_quality'] }}</li>
                                <li class="format-file-size">{{ format['file_size'] }}</li>
                                <li class="format-codecs">{{ format['codecs'] }}</li>
                            </ol>
                        </a>
                    </li>
                {% endfor %}
                {% for download in other_downloads %}
                    <li class="download-format">
                        <a class="download-link" href="{{ download['url'] }}">
                            <ol class="format-attributes">
                                <li class="format-ext">{{ download['ext'] }}</li>
                                <li class="format-label">{{ download['label'] }}</li>
                            </ol>
                        </a>
                    </li>
                {% endfor %}
            </ul>
        </details>


        <details class="description-container">
            <summary>Description</summary>
            <span class="description">{{ common_elements.text_runs(description)|escape|urlize|timestamps|safe }}</span>
        </details>


        <div class="music-list">
            {% if music_list.__len__() != 0 %}
                <hr>
                <table>
                    <caption>Music</caption>
                    <tr>
                        {% for attribute in music_attributes %}
                            <th>{{ attribute }}</th>
                        {% endfor %}
                    </tr>
                    {% for track in music_list %}
                        <tr>
                            {% for attribute in music_attributes %}
                                {% if attribute.lower() == 'title' and track['url'] is not none %}
                                    <td><a href="{{ track['url'] }}">{{ track.get(attribute.lower(), '') }}</a></td>
                                {% else %}
                                    <td>{{ track.get(attribute.lower(), '') }}</td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </table>
            {% endif %}
        </div>
        <details class="more-info">
            <summary>More info</summary>
            <div class="more-info-content">
                <p>Tor exit node: {{ ip_address }}</p>
                {% if invidious_used %}
                    <p>Used Invidious as fallback.</p>
                {% endif %}
                <p class="allowed-countries">Allowed countries: {{ allowed_countries|join(', ') }}</p>

                {% if settings.use_sponsorblock_js %}
                <ul class="more-actions">
                <li><label><input type=checkbox id=skip_sponsors checked>skip sponsors</label> <span id=skip_n></span>
                </ul>
                {% endif %}
            </div>
        </details>
    </div>

    <div class="side-and-comments-container">
      <div class="side-videos">
          {% if playlist %}
              <div class="playlist">
                  <div class="playlist-header">
                      <a href="{{ playlist['url'] }}" title="{{ playlist['title'] }}"><h3>{{ playlist['title'] }}</h3></a>
                      <ul class="playlist-metadata">
                          <li>Autoplay: <input type="checkbox" id="autoplay-toggle"></li>
                          {% if playlist['current_index'] is none %}
                              <li>[Error!]/{{ playlist['video_count'] }}</li>
                          {% else %}
                              <li>{{ playlist['current_index']+1 }}/{{ playlist['video_count'] }}</li>
                          {% endif %}
                          <li><a href="{{ playlist['author_url'] }}" title="{{ playlist['author'] }}">{{ playlist['author'] }}</a></li>
                      </ul>
                  </div>
                  <nav class="playlist-videos">
                      {% for info in playlist['items'] %}
                          {# non-lazy load for 5 videos surrounding current video #}
                          {# for non-js browsers or old such that IntersectionObserver doesn't work #}
                          {# -10 is sentinel to not load anything if there's no current_index for some reason #}
                          {% if (playlist.get('current_index', -10) - loop.index0)|abs is lt(5)  %}
                              {{ common_elements.item(info, include_badges=false, lazy_load=false) }}
                          {% else %}
                              {{ common_elements.item(info, include_badges=false, lazy_load=true) }}
                          {% endif %}
                      {% endfor %}
                  </nav>
              </div>
          {% elif settings.related_videos_mode != 0 %}
              <div class="autoplay-toggle-container"><label for="autoplay-toggle">Autoplay: </label><input type="checkbox" id="autoplay-toggle"></div>
          {% endif %}


          {% if subtitle_sources %}
              <details id="transcript-details">
                  <summary>Transcript</summary>
                  <div id="transcript-div">
                      <select id="select-tt">
                          {% for source in subtitle_sources %}
                              <option>{{ source['label'] }}</option>
                          {% endfor %}
                      </select>
                      <label for="transcript-use-table">Table view</label>
                      <input type="checkbox" id="transcript-use-table">
                      <table id="transcript-table"></table>
                  </div>
              </details>
          {% endif %}

          {% if settings.related_videos_mode != 0 %}
              <details class="related-videos-outer" {{'open' if settings.related_videos_mode == 1 else ''}}>
                  <summary>Related Videos</summary>
                  <nav class="related-videos-inner">
                      {% for info in related %}
                          {{ common_elements.item(info, include_badges=false) }}
                      {% endfor %}
                  </nav>
              </details>
          {% endif %}
      </div>

       {% if chapters and chapters|length > 0 %}
       <div class="chapters-above-comments">
           <h3>Chapters</h3>
           <div class="chapters-checkbox-list">
               {% for chapter in chapters %}
               <label class="chapter-checkbox-item">
                   <input type="checkbox" class="chapter-checkbox">
                   <span class="chapter-time" id="chapter-time-{{ loop.index }}">{{ chapter.start_time | int }}</span>
                   <span class="chapter-title" data-time="{{ chapter.start_time }}">{{ chapter.title }}</span>
               </label>
               {% endfor %}
           </div>
       </div>
       {% endif %}

       {% if settings.comments_mode != 0 %}
           {% if comments_disabled %}
               <div class="comments-area-outer comments-disabled">Comments disabled</div>
           {% else %}
              <details class="comments-area-outer" {{'open' if settings.comments_mode == 1 else ''}}>
                  <summary>{{ comment_count|commatize }} comment{{'s' if comment_count != '1' else ''}}</summary>
                  <section class="comments-area-inner comments-area">
                      {% if comments_info %}
                          {{ comments.video_comments(comments_info) }}
                      {% endif %}
                  </section>
              </details>
          {% endif %}
      {% endif %}

    </div>

    <script src="/youtube.com/static/js/av-merge.js"></script>
    <script src="/youtube.com/static/js/watch.js"></script>
    {% if settings.video_player == 1 %}
        <!-- plyr -->
        <script>var storyboard_url = {{ storyboard_url | tojson }}</script>
        <script src="/youtube.com/static/modules/plyr/plyr.js"></script>
        <script src="/youtube.com/static/js/plyr-start.js"></script>
        <!-- /plyr -->
    {% endif %}
    <script src="/youtube.com/static/js/common.js"></script>
    <script src="/youtube.com/static/js/transcript-table.js"></script>
    {% if settings.use_video_hotkeys %} <script src="/youtube.com/static/js/hotkeys.js"></script> {% endif %}
    {% if settings.use_comments_js %} <script src="/youtube.com/static/js/comments.js"></script> {% endif %}
    {% if settings.use_sponsorblock_js %} <script src="/youtube.com/static/js/sponsorblock.js"></script> {% endif %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const videoPlayer = document.querySelector('video');
            const speedControlInput = document.getElementById('speed-control');

            function setVideoSpeed(speed) {
                if (!isNaN(speed) && speed > 0) {
                    videoPlayer.playbackRate = speed;
                localStorage.setItem('videoPlaybackSpeed', speed); // Save speed to localStorage
                }
            }

            speedControlInput.addEventListener('input', function() {
                setVideoSpeed(parseFloat(this.value));
            });

            // Sync input with current playback rate if it changes externally (e.g., by hotkeys or other scripts)
            videoPlayer.addEventListener('ratechange', function() {
                const currentRate = videoPlayer.playbackRate;
                if (parseFloat(speedControlInput.value) !== currentRate) {
                    speedControlInput.value = currentRate.toFixed(2); // Display current rate with 2 decimal places
                }
            });

            // Load and set playback speed from localStorage, or use default if not found
            const savedSpeed = localStorage.getItem('videoPlaybackSpeed');
            if (savedSpeed) {
                const parsedSpeed = parseFloat(savedSpeed);
                if (!isNaN(parsedSpeed) && parsedSpeed > 0) {
                    videoPlayer.playbackRate = parsedSpeed;
                }
            }
            // Set initial value of the input to the current
            speedControlInput.value = videoPlayer.playbackRate.toFixed(2);

            // Format chapter timestamps
            function formatTime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = Math.floor(seconds % 60);

                if (hours > 0) {
                    return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                } else {
                    return `${minutes}:${secs.toString().padStart(2, '0')}`;
                }
            }

            // Format all chapter times
            document.querySelectorAll('[id^="chapter-time-"]').forEach(el => {
                const seconds = parseInt(el.textContent);
                el.textContent = formatTime(seconds);
            });

            // Handle chapter title clicks
            const chapterTitles = document.querySelectorAll('.chapter-title');
            chapterTitles.forEach(title => {
                title.addEventListener('click', function() {
                    const time = parseFloat(this.dataset.time);
                    if (videoPlayer) {
                        videoPlayer.currentTime = time;
                        videoPlayer.play();
                    }
                });
            });
        });
    </script>
{% endblock main %}

